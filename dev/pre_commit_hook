#!/bin/bash
# ==============================================================================
# PRE-COMMIT HOOK FOR R PACKAGE DEVELOPMENT
# ==============================================================================
#
# This hook runs automatically before each git commit to ensure code quality.
#
# WHAT IT DOES:
#   1. Runs jarl linter with auto-fix (if jarl is installed)
#   2. Runs air formatter on all R files (if air is installed)
#   3. Updates package documentation (devtools::document())
#   4. Runs R CMD check with CRAN standards
#
# REQUIREMENTS:
#   - jarl (optional but recommended): Fast Rust-based linter
#   - air (optional but recommended): Rust-based formatter
#   - R with devtools package (required)
#
# TO SKIP THIS HOOK FOR A SINGLE COMMIT:
#   git commit --no-verify -m "your message"
#   Use this for:
#     - Quick WIP commits during development
#     - Emergency hotfixes (but run checks immediately after!)
#     - When you know the check will fail but need to save progress
#   WARNING: Never push commits that haven't been checked!
#
# TO DISABLE THIS HOOK PERMANENTLY:
#   rm .git/hooks/pre-commit
#   # Or rename it: mv .git/hooks/pre-commit .git/hooks/pre-commit.disabled
#
# ==============================================================================

set -e  # Exit on first error

echo "================================================================================"
echo "PRE-COMMIT HOOK: Running code quality checks"
echo "================================================================================"
echo ""

# Colors for output (if terminal supports it)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track overall success
HOOK_FAILED=0

# ==============================================================================
# STEP 1: Jarl Linter (if available)
# ==============================================================================

echo "STEP 1/4: Running jarl linter..."
echo "--------------------------------------------------------------------------------"

if command -v jarl &> /dev/null; then
    echo "jarl found - running linter with auto-fix..."

    # Lint and auto-fix R directory
    if jarl lint --fix R/ 2>&1; then
        echo -e "${GREEN}✓ Jarl linting completed${NC}"

        # Stage any files that were auto-fixed (if they exist)
        if ls R/*.R 1> /dev/null 2>&1; then
            git add R/*.R
        fi
    else
        echo -e "${RED}✗ Jarl linting failed${NC}"
        echo "Fix the linting errors above before committing."
        HOOK_FAILED=1
    fi
else
    echo -e "${YELLOW}⚠ jarl not found - skipping linting${NC}"
    echo "Install jarl for fast linting: source('dev/install_linter_jarl.R')"
fi

echo ""

# ==============================================================================
# STEP 2: Air Formatter (if available)
# ==============================================================================

echo "STEP 2/4: Running air formatter..."
echo "--------------------------------------------------------------------------------"

if command -v air &> /dev/null; then
    echo "air found - formatting R files..."

    # Format all R files
    if air format . 2>&1; then
        echo -e "${GREEN}✓ Air formatting completed${NC}"

        # Stage any files that were formatted (if they exist)
        if ls R/*.R 1> /dev/null 2>&1; then
            git add R/*.R
        fi
        # Use find for tests since ** pattern may not work in all shells
        find tests -name "*.R" -type f 2>/dev/null | xargs -r git add
    else
        echo -e "${RED}✗ Air formatting failed${NC}"
        echo "Fix the formatting errors above before committing."
        HOOK_FAILED=1
    fi
else
    echo -e "${YELLOW}⚠ air not found - skipping formatting${NC}"
    echo "Air is configured in this package. It may be installed already."
    echo "Check: air --version"
fi

echo ""

# ==============================================================================
# STEP 3: Update Documentation
# ==============================================================================

echo "STEP 3/4: Updating package documentation..."
echo "--------------------------------------------------------------------------------"

if Rscript -e "devtools::document()" 2>&1; then
    echo -e "${GREEN}✓ Documentation updated${NC}"

    # Stage updated documentation files (if they exist)
    [ -d man ] && git add man/*.Rd 2>/dev/null || true
    [ -f NAMESPACE ] && git add NAMESPACE
    [ -f R/globals.R ] && git add R/globals.R
else
    echo -e "${RED}✗ Documentation update failed${NC}"
    echo "Fix documentation errors before committing."
    HOOK_FAILED=1
fi

echo ""

# ==============================================================================
# STEP 4: R CMD Check
# ==============================================================================

echo "STEP 4/4: Running R CMD check (CRAN standards)..."
echo "--------------------------------------------------------------------------------"
echo "NOTE: This may take 30-90 seconds. Use --no-verify to skip for quick commits."
echo ""

if Rscript -e "
    result <- devtools::check(
        document = FALSE,    # Already documented above
        cran = TRUE,         # CRAN standards
        error_on = 'error'   # Fail on errors only
    )

    # Exit with error code if there are errors
    if (length(result\$errors) > 0) {
        quit(status = 1)
    }
" 2>&1; then
    echo -e "${GREEN}✓ R CMD check passed${NC}"
else
    echo -e "${RED}✗ R CMD check failed${NC}"
    echo ""
    echo "Fix the errors above before committing."
    echo "Warnings and notes are allowed, but errors must be fixed."
    HOOK_FAILED=1
fi

echo ""

# ==============================================================================
# SUMMARY
# ==============================================================================

echo "================================================================================"
if [ $HOOK_FAILED -eq 0 ]; then
    echo -e "${GREEN}✓ PRE-COMMIT CHECKS PASSED${NC}"
    echo "================================================================================"
    echo ""
    echo "Your commit is ready to proceed."
    echo "All quality checks passed successfully."
    exit 0
else
    echo -e "${RED}✗ PRE-COMMIT CHECKS FAILED${NC}"
    echo "================================================================================"
    echo ""
    echo "Please fix the errors above before committing."
    echo ""
    echo "To commit anyway (not recommended):"
    echo "  git commit --no-verify -m 'your message'"
    echo ""
    exit 1
fi
